# GEngine Kustomization - Staging Overlay
# Use: kubectl apply -k k8s/overlays/staging
#
# This overlay:
# - Uses ClusterIP services with Ingress for external access
# - Configures higher resource limits for staging workloads
# - Uses image pull from registry
#
# Resource Sizing Rationale (Staging):
# - Simulation: Highest resources (game logic, tick processing, state management)
#   - 2x base limits for production-like load testing
# - Gateway: Moderate resources (WebSocket routing, connection handling)
#   - Scaled proportionally for multiple concurrent connections
# - LLM: Higher memory for context/buffering, moderate CPU (I/O-bound API calls)
#   - Memory-focused scaling for LLM request/response handling
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: gengine

resources:
  - ../../base

# Patches for staging environment
patches:
  # Simulation: Higher resources for staging workloads
  - target:
      kind: Deployment
      name: simulation
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "768Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "600m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "1536Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1500m"
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Always

  # Gateway: Moderate resources for staging
  - target:
      kind: Deployment
      name: gateway
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "384Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "300m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "768Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "800m"
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Always

  # LLM: Higher memory for staging, moderate CPU
  - target:
      kind: Deployment
      name: llm
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "640Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "400m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "1280Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1000m"
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Always

  # Update ingress for staging hostname
  - target:
      kind: Ingress
      name: gengine-ingress
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: gengine-staging.example.com

labels:
  - pairs:
      environment: staging
    includeSelectors: false

images:
  - name: gengine
    # IMPORTANT: For production/staging, replace 'latest' with a specific version tag.
    # Use semantic versioning or git commit hashes for reproducible deployments.
    #
    # To set a specific image and tag for your deployment:
    #   cd k8s/overlays/staging
    #   kustomize edit set image gengine=your-registry.example.com/gengine:v1.2.3
    #
    # Or use a git SHA for CI/CD pipelines:
    #   kustomize edit set image gengine=your-registry.example.com/gengine:sha-abc123
    #
    # Default is 'latest' for initial setup only
    newTag: latest
